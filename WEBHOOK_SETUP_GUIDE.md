# Webhook Setup Guide for Dodo Payments

## Overview

This guide helps you configure webhooks for your PrepBettr application to handle payment and subscription events from Dodo Payments.

## Webhook Endpoint

Your application provides a webhook endpoint at:

```
POST /api/webhooks/dodo
```

## Complete Webhook URLs

### Development Environment
```
http://localhost:3002/api/webhooks/dodo
```

### Production Environment
```
https://yourdomain.com/api/webhooks/dodo
```

**Note:** Replace `yourdomain.com` with your actual domain when deploying to production.

## Webhook Configuration in Dodo Payments

### Step 1: Access Dodo Payments Dashboard

1. Log into your Dodo Payments dashboard
2. Navigate to **Developers** â†’ **Webhooks** section
3. Click **Add Webhook** or **Create New Webhook**

### Step 2: Configure Webhook Settings

**Webhook URL:** 
- Development: `http://localhost:3002/api/webhooks/dodo`
- Production: `https://yourdomain.com/api/webhooks/dodo`

**HTTP Method:** `POST`

**Events to Subscribe:** Select the following events:
- `payment_intent.succeeded`
- `payment_intent.payment_failed`
- `subscription.created`
- `subscription.updated`
- `subscription.canceled`

**Webhook Secret:** This is generated by Dodo Payments. Copy this value.

### Step 3: Update Environment Variables

Add the webhook secret to your `.env.local` file:

```bash
# In .env.local
DODO_WEBHOOK_SECRET="wh_1234567890abcdef..."  # Replace with actual secret from Dodo
DODO_PAYMENTS_API_KEY="your_api_key_here"     # Your Dodo API key
DODO_PREMIUM_PRODUCT_ID="prod_premium_123"    # Your premium product ID
```

## Testing Webhooks

### 1. Using Our Test Script

Run the payment flow test to verify webhook processing:

```bash
# Make sure server is running
npm run dev

# In another terminal, run tests
node test-payment-simple.js
```

### 2. Using ngrok for Local Development

If you need to test webhooks from Dodo Payments to your local development server:

```bash
# Install ngrok (if not already installed)
npm install -g ngrok

# Expose your local server
ngrok http 3002

# Use the ngrok URL in Dodo webhook configuration
# Example: https://abc123.ngrok.io/api/webhooks/dodo
```

### 3. Manual Webhook Testing

You can test webhooks manually using curl:

```bash
# Generate a test signature
node -e "
const crypto = require('crypto');
const secret = 'your_webhook_secret';
const payload = JSON.stringify({
  id: 'evt_test_123',
  type: 'payment_intent.succeeded',
  data: {
    object: {
      id: 'pi_test_123',
      amount: 2999,
      currency: 'usd',
      status: 'succeeded',
      metadata: {
        userId: 'test_user_123',
        plan: 'premium'
      }
    }
  }
});
const signature = crypto.createHmac('sha256', secret).update(payload).digest('hex');
console.log('Payload:', payload);
console.log('Signature:', signature);
"

# Then use curl to send the webhook
curl -X POST http://localhost:3002/api/webhooks/dodo \
  -H "Content-Type: application/json" \
  -H "x-dodo-signature: YOUR_GENERATED_SIGNATURE" \
  -d 'YOUR_PAYLOAD_FROM_ABOVE'
```

## Webhook Events Handled

### Payment Events

#### `payment_intent.succeeded`
- **Action:** Activates user's premium subscription
- **Updates:** User plan to 'premium', status to 'active'
- **Metadata Required:** `userId`, `plan`

#### `payment_intent.payment_failed`
- **Action:** Logs the payment failure
- **Updates:** None (maintains current subscription)
- **Metadata Required:** `userId`

### Subscription Events

#### `subscription.created` / `subscription.updated`
- **Action:** Updates subscription details and resets usage counters if plan changed
- **Updates:** Plan type, status, period end, customer IDs
- **Metadata Required:** `userId`, `plan`

#### `subscription.canceled`
- **Action:** Downgrades to free plan and resets usage counters
- **Updates:** Plan to 'free', status to 'canceled'
- **Metadata Required:** `userId`

## Webhook Security

### Signature Verification

All webhooks are verified using HMAC SHA-256 signatures:

1. Dodo Payments signs the webhook payload with your webhook secret
2. The signature is sent in the `x-dodo-signature` header
3. Our endpoint verifies the signature before processing

### Error Handling

- **Invalid signatures** return `401 Unauthorized`
- **Missing webhook secret** returns `500 Internal Server Error`
- **Processing errors** are logged and return `400 Bad Request`
- **Duplicate events** (idempotency) return `200 OK` with `duplicate: true`

## Monitoring Webhooks

### Database Logging

All webhook events are logged in the `subscription_events` Firestore collection:

```javascript
{
  id: "auto-generated",
  eventId: "evt_from_dodo",
  userId: "user_firebase_id",
  eventType: "payment_intent.succeeded",
  timestamp: "2024-01-01T12:00:00Z",
  rawWebhookData: { /* original payload */ },
  parsedData: { /* processed data */ },
  processed: true,
  error?: "error message if any"
}
```

### Server Logs

Check your application logs for:
- `Received webhook event: [type] (ID: [id])`
- `User [userId]'s subscription updated successfully to [plan]`
- `Event [eventId] already processed, returning success`

## Troubleshooting

### Common Issues

1. **401 Invalid Signature**
   - Check webhook secret matches Dodo configuration
   - Verify signature generation algorithm

2. **500 Configuration Error**
   - Ensure `DODO_WEBHOOK_SECRET` is set in environment variables
   - Check if webhook secret exists in Dodo dashboard

3. **Missing User ID in Metadata**
   - Verify checkout creation includes `userId` in metadata
   - Check Dodo product configuration

4. **Webhook Not Receiving Events**
   - Verify webhook URL is accessible from internet (use ngrok for local testing)
   - Check webhook is enabled in Dodo dashboard
   - Verify selected events match what's being triggered

### Debug Mode

Enable debug logging by setting:

```bash
NODE_ENV=development
```

This will log additional webhook processing information.

## Production Deployment

### 1. Environment Variables

Ensure all required variables are set in production:
- `DODO_WEBHOOK_SECRET`
- `DODO_PAYMENTS_API_KEY`
- `DODO_PREMIUM_PRODUCT_ID`
- `FIREBASE_PROJECT_ID`
- `FIREBASE_PRIVATE_KEY`
- `FIREBASE_CLIENT_EMAIL`

### 2. HTTPS Requirement

Dodo Payments requires HTTPS for production webhook URLs.

### 3. Update Webhook URL

Change the webhook URL in Dodo dashboard from:
```
http://localhost:3002/api/webhooks/dodo
```
to:
```
https://yourdomain.com/api/webhooks/dodo
```

### 4. Test Production Webhooks

After deployment, test with a small transaction to ensure webhooks are working correctly.

## Support

If you encounter issues:

1. Check the test results from `test-payment-simple.js`
2. Review server logs for webhook processing
3. Verify webhook configuration in Dodo dashboard
4. Check Firestore `subscription_events` collection for event logs
5. Ensure all environment variables are properly set
