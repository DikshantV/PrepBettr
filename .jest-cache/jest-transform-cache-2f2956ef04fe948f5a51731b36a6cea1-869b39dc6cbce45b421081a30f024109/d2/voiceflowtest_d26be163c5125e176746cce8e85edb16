ee870e4b54279142e3bcff3598531862
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const globals_1 = require("@jest/globals");
const node_fetch_1 = __importDefault(require("node-fetch"));
const form_data_1 = __importDefault(require("form-data"));
const fs_1 = __importDefault(require("fs"));
const path_1 = __importDefault(require("path"));
// Test configuration
const API_BASE_URL = process.env.TEST_API_URL || 'http://localhost:3000';
const TEST_TIMEOUT = 30000; // 30 seconds
(0, globals_1.describe)('Voice STT → OpenAI Data Flow Integration', () => {
    let testAudioPath;
    (0, globals_1.beforeAll)(() => {
        // Path to test WAV file
        testAudioPath = path_1.default.join(__dirname, '../fixtures/test-audio.wav');
        // Create a test WAV file if it doesn't exist
        if (!fs_1.default.existsSync(testAudioPath)) {
            // Create directory if it doesn't exist
            const fixturesDir = path_1.default.dirname(testAudioPath);
            if (!fs_1.default.existsSync(fixturesDir)) {
                fs_1.default.mkdirSync(fixturesDir, { recursive: true });
            }
            // Create a simple WAV file with silence (44 bytes header + some data)
            const wavHeader = Buffer.alloc(44);
            // RIFF header
            wavHeader.write('RIFF', 0);
            wavHeader.writeUInt32LE(36 + 1600, 4); // File size - 8
            wavHeader.write('WAVE', 8);
            // fmt subchunk
            wavHeader.write('fmt ', 12);
            wavHeader.writeUInt32LE(16, 16); // Subchunk size
            wavHeader.writeUInt16LE(1, 20); // Audio format (PCM)
            wavHeader.writeUInt16LE(1, 22); // Number of channels
            wavHeader.writeUInt32LE(16000, 24); // Sample rate
            wavHeader.writeUInt32LE(32000, 28); // Byte rate
            wavHeader.writeUInt16LE(2, 32); // Block align
            wavHeader.writeUInt16LE(16, 34); // Bits per sample
            // data subchunk
            wavHeader.write('data', 36);
            wavHeader.writeUInt32LE(1600, 40); // Data size
            // Write header and some silence data
            const silenceData = Buffer.alloc(1600); // 100ms of silence at 16kHz
            fs_1.default.writeFileSync(testAudioPath, Buffer.concat([wavHeader, silenceData]));
        }
    });
    (0, globals_1.describe)('/api/voice/stream endpoint', () => {
        (0, globals_1.it)('should always return success:true with text field', async () => {
            const formData = new form_data_1.default();
            formData.append('audio', fs_1.default.createReadStream(testAudioPath), {
                filename: 'test-audio.wav',
                contentType: 'audio/wav'
            });
            const response = await (0, node_fetch_1.default)(`${API_BASE_URL}/api/voice/stream`, {
                method: 'POST',
                body: formData,
                headers: formData.getHeaders()
            });
            (0, globals_1.expect)(response.status).toBe(200);
            const result = await response.json();
            // Verify the response structure
            (0, globals_1.expect)(result).toHaveProperty('success');
            (0, globals_1.expect)(result.success).toBe(true);
            (0, globals_1.expect)(result).toHaveProperty('text');
            (0, globals_1.expect)(typeof result.text).toBe('string');
            // Even with empty/silent audio, should return success with empty text
            (0, globals_1.expect)(result).toHaveProperty('confidence');
            (0, globals_1.expect)(typeof result.confidence).toBe('number');
        }, TEST_TIMEOUT);
        (0, globals_1.it)('should handle missing audio file gracefully', async () => {
            const formData = new form_data_1.default();
            // Don't append any audio file
            const response = await (0, node_fetch_1.default)(`${API_BASE_URL}/api/voice/stream`, {
                method: 'POST',
                body: formData,
                headers: formData.getHeaders()
            });
            (0, globals_1.expect)(response.status).toBe(200);
            const result = await response.json();
            // Should still return success with empty text
            (0, globals_1.expect)(result.success).toBe(true);
            (0, globals_1.expect)(result.text).toBe('');
            (0, globals_1.expect)(result).toHaveProperty('error');
        }, TEST_TIMEOUT);
        (0, globals_1.it)('should handle invalid audio format gracefully', async () => {
            const formData = new form_data_1.default();
            // Send a text file instead of audio
            const invalidData = Buffer.from('This is not audio data');
            formData.append('audio', invalidData, {
                filename: 'invalid.txt',
                contentType: 'text/plain'
            });
            const response = await (0, node_fetch_1.default)(`${API_BASE_URL}/api/voice/stream`, {
                method: 'POST',
                body: formData,
                headers: formData.getHeaders()
            });
            (0, globals_1.expect)(response.status).toBe(200);
            const result = await response.json();
            // Should still return success with empty text
            (0, globals_1.expect)(result.success).toBe(true);
            (0, globals_1.expect)(result.text).toBe('');
            (0, globals_1.expect)(result).toHaveProperty('error');
            (0, globals_1.expect)(result.error).toContain('Unsupported audio format');
        }, TEST_TIMEOUT);
    });
    (0, globals_1.describe)('/api/voice/conversation endpoint', () => {
        (0, globals_1.it)('should process text and return AI response', async () => {
            // First, start the conversation
            const startResponse = await (0, node_fetch_1.default)(`${API_BASE_URL}/api/voice/conversation`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'start',
                    interviewContext: {
                        type: 'general',
                        maxQuestions: 5
                    }
                })
            });
            (0, globals_1.expect)(startResponse.status).toBe(200);
            const startResult = await startResponse.json();
            (0, globals_1.expect)(startResult.success).toBe(true);
            (0, globals_1.expect)(startResult).toHaveProperty('message');
            (0, globals_1.expect)(startResult).toHaveProperty('questionNumber');
            // Then process a user response
            const processResponse = await (0, node_fetch_1.default)(`${API_BASE_URL}/api/voice/conversation`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'process',
                    userTranscript: 'I have 5 years of experience in software development'
                })
            });
            (0, globals_1.expect)(processResponse.status).toBe(200);
            const processResult = await processResponse.json();
            (0, globals_1.expect)(processResult.success).toBe(true);
            (0, globals_1.expect)(processResult).toHaveProperty('message');
            (0, globals_1.expect)(processResult).toHaveProperty('questionNumber');
            (0, globals_1.expect)(processResult).toHaveProperty('isComplete');
        }, TEST_TIMEOUT);
        (0, globals_1.it)('should handle retry with exponential backoff', async () => {
            // This test simulates multiple rapid requests to test retry logic
            const promises = [];
            for (let i = 0; i < 3; i++) {
                promises.push((0, node_fetch_1.default)(`${API_BASE_URL}/api/voice/conversation`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'process',
                        userTranscript: `Test message ${i}`
                    })
                }));
            }
            const responses = await Promise.all(promises);
            // All requests should eventually succeed
            for (const response of responses) {
                (0, globals_1.expect)(response.status).toBe(200);
                const result = await response.json();
                (0, globals_1.expect)(result).toHaveProperty('success');
            }
        }, TEST_TIMEOUT * 2);
    });
    (0, globals_1.describe)('End-to-End Voice Flow', () => {
        (0, globals_1.it)('should complete full STT → OpenAI flow', async () => {
            // Step 1: Upload audio to STT
            const formData = new form_data_1.default();
            formData.append('audio', fs_1.default.createReadStream(testAudioPath), {
                filename: 'test-audio.wav',
                contentType: 'audio/wav'
            });
            const sttResponse = await (0, node_fetch_1.default)(`${API_BASE_URL}/api/voice/stream`, {
                method: 'POST',
                body: formData,
                headers: formData.getHeaders()
            });
            (0, globals_1.expect)(sttResponse.status).toBe(200);
            const sttResult = await sttResponse.json();
            (0, globals_1.expect)(sttResult.success).toBe(true);
            (0, globals_1.expect)(sttResult).toHaveProperty('text');
            // Step 2: If we got text, send it to conversation API
            if (sttResult.text && sttResult.text.trim()) {
                const conversationResponse = await (0, node_fetch_1.default)(`${API_BASE_URL}/api/voice/conversation`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'process',
                        userTranscript: sttResult.text
                    })
                });
                (0, globals_1.expect)(conversationResponse.status).toBe(200);
                const conversationResult = await conversationResponse.json();
                (0, globals_1.expect)(conversationResult.success).toBe(true);
                (0, globals_1.expect)(conversationResult).toHaveProperty('message');
                (0, globals_1.expect)(typeof conversationResult.message).toBe('string');
            }
        }, TEST_TIMEOUT);
    });
    (0, globals_1.afterAll)(() => {
        // Cleanup can be added here if needed
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rpa3NoYW50dmFzaGlzdGhhL1ByZXBCZXR0ci90ZXN0cy9pbnRlZ3JhdGlvbi92b2ljZS1mbG93LnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSwyQ0FBMEU7QUFDMUUsNERBQStCO0FBQy9CLDBEQUFpQztBQUNqQyw0Q0FBb0I7QUFDcEIsZ0RBQXdCO0FBRXhCLHFCQUFxQjtBQUNyQixNQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFlBQVksSUFBSSx1QkFBdUIsQ0FBQztBQUN6RSxNQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsQ0FBQyxhQUFhO0FBRXpDLElBQUEsa0JBQVEsRUFBQywwQ0FBMEMsRUFBRSxHQUFHLEVBQUU7SUFDeEQsSUFBSSxhQUFxQixDQUFDO0lBRTFCLElBQUEsbUJBQVMsRUFBQyxHQUFHLEVBQUU7UUFDYix3QkFBd0I7UUFDeEIsYUFBYSxHQUFHLGNBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLDRCQUE0QixDQUFDLENBQUM7UUFFbkUsNkNBQTZDO1FBQzdDLElBQUksQ0FBQyxZQUFFLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUM7WUFDbEMsdUNBQXVDO1lBQ3ZDLE1BQU0sV0FBVyxHQUFHLGNBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7WUFDaEQsSUFBSSxDQUFDLFlBQUUsQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQztnQkFDaEMsWUFBRSxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUUsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUNqRCxDQUFDO1lBRUQsc0VBQXNFO1lBQ3RFLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDbkMsY0FBYztZQUNkLFNBQVMsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzNCLFNBQVMsQ0FBQyxhQUFhLENBQUMsRUFBRSxHQUFHLElBQUks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YW50dmFzaGlzdGhhL1ByZXBCZXR0ci90ZXN0cy9pbnRlZ3JhdGlvbi92b2ljZS1mbG93LnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZGVzY3JpYmUsIGl0LCBleHBlY3QsIGJlZm9yZUFsbCwgYWZ0ZXJBbGwgfSBmcm9tICdAamVzdC9nbG9iYWxzJztcbmltcG9ydCBmZXRjaCBmcm9tICdub2RlLWZldGNoJztcbmltcG9ydCBGb3JtRGF0YSBmcm9tICdmb3JtLWRhdGEnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG4vLyBUZXN0IGNvbmZpZ3VyYXRpb25cbmNvbnN0IEFQSV9CQVNFX1VSTCA9IHByb2Nlc3MuZW52LlRFU1RfQVBJX1VSTCB8fCAnaHR0cDovL2xvY2FsaG9zdDozMDAwJztcbmNvbnN0IFRFU1RfVElNRU9VVCA9IDMwMDAwOyAvLyAzMCBzZWNvbmRzXG5cbmRlc2NyaWJlKCdWb2ljZSBTVFQg4oaSIE9wZW5BSSBEYXRhIEZsb3cgSW50ZWdyYXRpb24nLCAoKSA9PiB7XG4gIGxldCB0ZXN0QXVkaW9QYXRoOiBzdHJpbmc7XG4gIFxuICBiZWZvcmVBbGwoKCkgPT4ge1xuICAgIC8vIFBhdGggdG8gdGVzdCBXQVYgZmlsZVxuICAgIHRlc3RBdWRpb1BhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vZml4dHVyZXMvdGVzdC1hdWRpby53YXYnKTtcbiAgICBcbiAgICAvLyBDcmVhdGUgYSB0ZXN0IFdBViBmaWxlIGlmIGl0IGRvZXNuJ3QgZXhpc3RcbiAgICBpZiAoIWZzLmV4aXN0c1N5bmModGVzdEF1ZGlvUGF0aCkpIHtcbiAgICAgIC8vIENyZWF0ZSBkaXJlY3RvcnkgaWYgaXQgZG9lc24ndCBleGlzdFxuICAgICAgY29uc3QgZml4dHVyZXNEaXIgPSBwYXRoLmRpcm5hbWUodGVzdEF1ZGlvUGF0aCk7XG4gICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoZml4dHVyZXNEaXIpKSB7XG4gICAgICAgIGZzLm1rZGlyU3luYyhmaXh0dXJlc0RpciwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIENyZWF0ZSBhIHNpbXBsZSBXQVYgZmlsZSB3aXRoIHNpbGVuY2UgKDQ0IGJ5dGVzIGhlYWRlciArIHNvbWUgZGF0YSlcbiAgICAgIGNvbnN0IHdhdkhlYWRlciA9IEJ1ZmZlci5hbGxvYyg0NCk7XG4gICAgICAvLyBSSUZGIGhlYWRlclxuICAgICAgd2F2SGVhZGVyLndyaXRlKCdSSUZGJywgMCk7XG4gICAgICB3YXZIZWFkZXIud3JpdGVVSW50MzJMRSgzNiArIDE2MDAsIDQpOyAvLyBGaWxlIHNpemUgLSA4XG4gICAgICB3YXZIZWFkZXIud3JpdGUoJ1dBVkUnLCA4KTtcbiAgICAgIFxuICAgICAgLy8gZm10IHN1YmNodW5rXG4gICAgICB3YXZIZWFkZXIud3JpdGUoJ2ZtdCAnLCAxMik7XG4gICAgICB3YXZIZWFkZXIud3JpdGVVSW50MzJMRSgxNiwgMTYpOyAvLyBTdWJjaHVuayBzaXplXG4gICAgICB3YXZIZWFkZXIud3JpdGVVSW50MTZMRSgxLCAyMCk7IC8vIEF1ZGlvIGZvcm1hdCAoUENNKVxuICAgICAgd2F2SGVhZGVyLndyaXRlVUludDE2TEUoMSwgMjIpOyAvLyBOdW1iZXIgb2YgY2hhbm5lbHNcbiAgICAgIHdhdkhlYWRlci53cml0ZVVJbnQzMkxFKDE2MDAwLCAyNCk7IC8vIFNhbXBsZSByYXRlXG4gICAgICB3YXZIZWFkZXIud3JpdGVVSW50MzJMRSgzMjAwMCwgMjgpOyAvLyBCeXRlIHJhdGVcbiAgICAgIHdhdkhlYWRlci53cml0ZVVJbnQxNkxFKDIsIDMyKTsgLy8gQmxvY2sgYWxpZ25cbiAgICAgIHdhdkhlYWRlci53cml0ZVVJbnQxNkxFKDE2LCAzNCk7IC8vIEJpdHMgcGVyIHNhbXBsZVxuICAgICAgXG4gICAgICAvLyBkYXRhIHN1YmNodW5rXG4gICAgICB3YXZIZWFkZXIud3JpdGUoJ2RhdGEnLCAzNik7XG4gICAgICB3YXZIZWFkZXIud3JpdGVVSW50MzJMRSgxNjAwLCA0MCk7IC8vIERhdGEgc2l6ZVxuICAgICAgXG4gICAgICAvLyBXcml0ZSBoZWFkZXIgYW5kIHNvbWUgc2lsZW5jZSBkYXRhXG4gICAgICBjb25zdCBzaWxlbmNlRGF0YSA9IEJ1ZmZlci5hbGxvYygxNjAwKTsgLy8gMTAwbXMgb2Ygc2lsZW5jZSBhdCAxNmtIelxuICAgICAgZnMud3JpdGVGaWxlU3luYyh0ZXN0QXVkaW9QYXRoLCBCdWZmZXIuY29uY2F0KFt3YXZIZWFkZXIsIHNpbGVuY2VEYXRhXSkpO1xuICAgIH1cbiAgfSk7XG4gIFxuICBkZXNjcmliZSgnL2FwaS92b2ljZS9zdHJlYW0gZW5kcG9pbnQnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBhbHdheXMgcmV0dXJuIHN1Y2Nlc3M6dHJ1ZSB3aXRoIHRleHQgZmllbGQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuICAgICAgZm9ybURhdGEuYXBwZW5kKCdhdWRpbycsIGZzLmNyZWF0ZVJlYWRTdHJlYW0odGVzdEF1ZGlvUGF0aCksIHtcbiAgICAgICAgZmlsZW5hbWU6ICd0ZXN0LWF1ZGlvLndhdicsXG4gICAgICAgIGNvbnRlbnRUeXBlOiAnYXVkaW8vd2F2J1xuICAgICAgfSk7XG4gICAgICBcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYCR7QVBJX0JBU0VfVVJMfS9hcGkvdm9pY2Uvc3RyZWFtYCwge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgYm9keTogZm9ybURhdGEgYXMgYW55LFxuICAgICAgICBoZWFkZXJzOiBmb3JtRGF0YS5nZXRIZWFkZXJzKClcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKDIwMCk7XG4gICAgICBcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKSBhcyBhbnk7XG4gICAgICBcbiAgICAgIC8vIFZlcmlmeSB0aGUgcmVzcG9uc2Ugc3RydWN0dXJlXG4gICAgICBleHBlY3QocmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgnc3VjY2VzcycpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9IYXZlUHJvcGVydHkoJ3RleHQnKTtcbiAgICAgIGV4cGVjdCh0eXBlb2YgcmVzdWx0LnRleHQpLnRvQmUoJ3N0cmluZycpO1xuICAgICAgXG4gICAgICAvLyBFdmVuIHdpdGggZW1wdHkvc2lsZW50IGF1ZGlvLCBzaG91bGQgcmV0dXJuIHN1Y2Nlc3Mgd2l0aCBlbXB0eSB0ZXh0XG4gICAgICBleHBlY3QocmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgnY29uZmlkZW5jZScpO1xuICAgICAgZXhwZWN0KHR5cGVvZiByZXN1bHQuY29uZmlkZW5jZSkudG9CZSgnbnVtYmVyJyk7XG4gICAgfSwgVEVTVF9USU1FT1VUKTtcbiAgICBcbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBtaXNzaW5nIGF1ZGlvIGZpbGUgZ3JhY2VmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgICAvLyBEb24ndCBhcHBlbmQgYW55IGF1ZGlvIGZpbGVcbiAgICAgIFxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgJHtBUElfQkFTRV9VUkx9L2FwaS92b2ljZS9zdHJlYW1gLCB7XG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICBib2R5OiBmb3JtRGF0YSBhcyBhbnksXG4gICAgICAgIGhlYWRlcnM6IGZvcm1EYXRhLmdldEhlYWRlcnMoKVxuICAgICAgfSk7XG4gICAgICBcbiAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICAgIFxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVzcG9uc2UuanNvbigpIGFzIGFueTtcbiAgICAgIFxuICAgICAgLy8gU2hvdWxkIHN0aWxsIHJldHVybiBzdWNjZXNzIHdpdGggZW1wdHkgdGV4dFxuICAgICAgZXhwZWN0KHJlc3VsdC5zdWNjZXNzKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHJlc3VsdC50ZXh0KS50b0JlKCcnKTtcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvSGF2ZVByb3BlcnR5KCdlcnJvcicpO1xuICAgIH0sIFRFU1RfVElNRU9VVCk7XG4gICAgXG4gICAgaXQoJ3Nob3VsZCBoYW5kbGUgaW52YWxpZCBhdWRpbyBmb3JtYXQgZ3JhY2VmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgICAvLyBTZW5kIGEgdGV4dCBmaWxlIGluc3RlYWQgb2YgYXVkaW9cbiAgICAgIGNvbnN0IGludmFsaWREYXRhID0gQnVmZmVyLmZyb20oJ1RoaXMgaXMgbm90IGF1ZGlvIGRhdGEnKTtcbiAgICAgIGZvcm1EYXRhLmFwcGVuZCgnYXVkaW8nLCBpbnZhbGlkRGF0YSwge1xuICAgICAgICBmaWxlbmFtZTogJ2ludmFsaWQudHh0JyxcbiAgICAgICAgY29udGVudFR5cGU6ICd0ZXh0L3BsYWluJ1xuICAgICAgfSk7XG4gICAgICBcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYCR7QVBJX0JBU0VfVVJMfS9hcGkvdm9pY2Uvc3RyZWFtYCwge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgYm9keTogZm9ybURhdGEgYXMgYW55LFxuICAgICAgICBoZWFkZXJzOiBmb3JtRGF0YS5nZXRIZWFkZXJzKClcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKDIwMCk7XG4gICAgICBcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKSBhcyBhbnk7XG4gICAgICBcbiAgICAgIC8vIFNob3VsZCBzdGlsbCByZXR1cm4gc3VjY2VzcyB3aXRoIGVtcHR5IHRleHRcbiAgICAgIGV4cGVjdChyZXN1bHQuc3VjY2VzcykudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChyZXN1bHQudGV4dCkudG9CZSgnJyk7XG4gICAgICBleHBlY3QocmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgnZXJyb3InKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3IpLnRvQ29udGFpbignVW5zdXBwb3J0ZWQgYXVkaW8gZm9ybWF0Jyk7XG4gICAgfSwgVEVTVF9USU1FT1VUKTtcbiAgfSk7XG4gIFxuICBkZXNjcmliZSgnL2FwaS92b2ljZS9jb252ZXJzYXRpb24gZW5kcG9pbnQnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBwcm9jZXNzIHRleHQgYW5kIHJldHVybiBBSSByZXNwb25zZScsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIEZpcnN0LCBzdGFydCB0aGUgY29udmVyc2F0aW9uXG4gICAgICBjb25zdCBzdGFydFJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYCR7QVBJX0JBU0VfVVJMfS9hcGkvdm9pY2UvY29udmVyc2F0aW9uYCwge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgaGVhZGVyczogeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0sXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBhY3Rpb246ICdzdGFydCcsXG4gICAgICAgICAgaW50ZXJ2aWV3Q29udGV4dDoge1xuICAgICAgICAgICAgdHlwZTogJ2dlbmVyYWwnLFxuICAgICAgICAgICAgbWF4UXVlc3Rpb25zOiA1XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSk7XG4gICAgICBcbiAgICAgIGV4cGVjdChzdGFydFJlc3BvbnNlLnN0YXR1cykudG9CZSgyMDApO1xuICAgICAgXG4gICAgICBjb25zdCBzdGFydFJlc3VsdCA9IGF3YWl0IHN0YXJ0UmVzcG9uc2UuanNvbigpIGFzIGFueTtcbiAgICAgIGV4cGVjdChzdGFydFJlc3VsdC5zdWNjZXNzKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHN0YXJ0UmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgnbWVzc2FnZScpO1xuICAgICAgZXhwZWN0KHN0YXJ0UmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgncXVlc3Rpb25OdW1iZXInKTtcbiAgICAgIFxuICAgICAgLy8gVGhlbiBwcm9jZXNzIGEgdXNlciByZXNwb25zZVxuICAgICAgY29uc3QgcHJvY2Vzc1Jlc3BvbnNlID0gYXdhaXQgZmV0Y2goYCR7QVBJX0JBU0VfVVJMfS9hcGkvdm9pY2UvY29udmVyc2F0aW9uYCwge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgaGVhZGVyczogeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0sXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBhY3Rpb246ICdwcm9jZXNzJyxcbiAgICAgICAgICB1c2VyVHJhbnNjcmlwdDogJ0kgaGF2ZSA1IHllYXJzIG9mIGV4cGVyaWVuY2UgaW4gc29mdHdhcmUgZGV2ZWxvcG1lbnQnXG4gICAgICAgIH0pXG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgZXhwZWN0KHByb2Nlc3NSZXNwb25zZS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICAgIFxuICAgICAgY29uc3QgcHJvY2Vzc1Jlc3VsdCA9IGF3YWl0IHByb2Nlc3NSZXNwb25zZS5qc29uKCkgYXMgYW55O1xuICAgICAgZXhwZWN0KHByb2Nlc3NSZXN1bHQuc3VjY2VzcykudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChwcm9jZXNzUmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgnbWVzc2FnZScpO1xuICAgICAgZXhwZWN0KHByb2Nlc3NSZXN1bHQpLnRvSGF2ZVByb3BlcnR5KCdxdWVzdGlvbk51bWJlcicpO1xuICAgICAgZXhwZWN0KHByb2Nlc3NSZXN1bHQpLnRvSGF2ZVByb3BlcnR5KCdpc0NvbXBsZXRlJyk7XG4gICAgfSwgVEVTVF9USU1FT1VUKTtcbiAgICBcbiAgICBpdCgnc2hvdWxkIGhhbmRsZSByZXRyeSB3aXRoIGV4cG9uZW50aWFsIGJhY2tvZmYnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBUaGlzIHRlc3Qgc2ltdWxhdGVzIG11bHRpcGxlIHJhcGlkIHJlcXVlc3RzIHRvIHRlc3QgcmV0cnkgbG9naWNcbiAgICAgIGNvbnN0IHByb21pc2VzID0gW107XG4gICAgICBcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMzsgaSsrKSB7XG4gICAgICAgIHByb21pc2VzLnB1c2goXG4gICAgICAgICAgZmV0Y2goYCR7QVBJX0JBU0VfVVJMfS9hcGkvdm9pY2UvY29udmVyc2F0aW9uYCwge1xuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAgICBoZWFkZXJzOiB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSxcbiAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgYWN0aW9uOiAncHJvY2VzcycsXG4gICAgICAgICAgICAgIHVzZXJUcmFuc2NyaXB0OiBgVGVzdCBtZXNzYWdlICR7aX1gXG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGNvbnN0IHJlc3BvbnNlcyA9IGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTtcbiAgICAgIFxuICAgICAgLy8gQWxsIHJlcXVlc3RzIHNob3VsZCBldmVudHVhbGx5IHN1Y2NlZWRcbiAgICAgIGZvciAoY29uc3QgcmVzcG9uc2Ugb2YgcmVzcG9uc2VzKSB7XG4gICAgICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcmVzcG9uc2UuanNvbigpIGFzIGFueTtcbiAgICAgICAgZXhwZWN0KHJlc3VsdCkudG9IYXZlUHJvcGVydHkoJ3N1Y2Nlc3MnKTtcbiAgICAgIH1cbiAgICB9LCBURVNUX1RJTUVPVVQgKiAyKTtcbiAgfSk7XG4gIFxuICBkZXNjcmliZSgnRW5kLXRvLUVuZCBWb2ljZSBGbG93JywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY29tcGxldGUgZnVsbCBTVFQg4oaSIE9wZW5BSSBmbG93JywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gU3RlcCAxOiBVcGxvYWQgYXVkaW8gdG8gU1RUXG4gICAgICBjb25zdCBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuICAgICAgZm9ybURhdGEuYXBwZW5kKCdhdWRpbycsIGZzLmNyZWF0ZVJlYWRTdHJlYW0odGVzdEF1ZGlvUGF0aCksIHtcbiAgICAgICAgZmlsZW5hbWU6ICd0ZXN0LWF1ZGlvLndhdicsXG4gICAgICAgIGNvbnRlbnRUeXBlOiAnYXVkaW8vd2F2J1xuICAgICAgfSk7XG4gICAgICBcbiAgICAgIGNvbnN0IHN0dFJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYCR7QVBJX0JBU0VfVVJMfS9hcGkvdm9pY2Uvc3RyZWFtYCwge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgYm9keTogZm9ybURhdGEgYXMgYW55LFxuICAgICAgICBoZWFkZXJzOiBmb3JtRGF0YS5nZXRIZWFkZXJzKClcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICBleHBlY3Qoc3R0UmVzcG9uc2Uuc3RhdHVzKS50b0JlKDIwMCk7XG4gICAgICBcbiAgICAgIGNvbnN0IHN0dFJlc3VsdCA9IGF3YWl0IHN0dFJlc3BvbnNlLmpzb24oKSBhcyBhbnk7XG4gICAgICBleHBlY3Qoc3R0UmVzdWx0LnN1Y2Nlc3MpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3Qoc3R0UmVzdWx0KS50b0hhdmVQcm9wZXJ0eSgndGV4dCcpO1xuICAgICAgXG4gICAgICAvLyBTdGVwIDI6IElmIHdlIGdvdCB0ZXh0LCBzZW5kIGl0IHRvIGNvbnZlcnNhdGlvbiBBUElcbiAgICAgIGlmIChzdHRSZXN1bHQudGV4dCAmJiBzdHRSZXN1bHQudGV4dC50cmltKCkpIHtcbiAgICAgICAgY29uc3QgY29udmVyc2F0aW9uUmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgJHtBUElfQkFTRV9VUkx9L2FwaS92b2ljZS9jb252ZXJzYXRpb25gLCB7XG4gICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAgaGVhZGVyczogeyAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nIH0sXG4gICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgYWN0aW9uOiAncHJvY2VzcycsXG4gICAgICAgICAgICB1c2VyVHJhbnNjcmlwdDogc3R0UmVzdWx0LnRleHRcbiAgICAgICAgICB9KVxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGV4cGVjdChjb252ZXJzYXRpb25SZXNwb25zZS5zdGF0dXMpLnRvQmUoMjAwKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGNvbnZlcnNhdGlvblJlc3VsdCA9IGF3YWl0IGNvbnZlcnNhdGlvblJlc3BvbnNlLmpzb24oKSBhcyBhbnk7XG4gICAgICAgIGV4cGVjdChjb252ZXJzYXRpb25SZXN1bHQuc3VjY2VzcykudG9CZSh0cnVlKTtcbiAgICAgICAgZXhwZWN0KGNvbnZlcnNhdGlvblJlc3VsdCkudG9IYXZlUHJvcGVydHkoJ21lc3NhZ2UnKTtcbiAgICAgICAgZXhwZWN0KHR5cGVvZiBjb252ZXJzYXRpb25SZXN1bHQubWVzc2FnZSkudG9CZSgnc3RyaW5nJyk7XG4gICAgICB9XG4gICAgfSwgVEVTVF9USU1FT1VUKTtcbiAgfSk7XG4gIFxuICBhZnRlckFsbCgoKSA9PiB7XG4gICAgLy8gQ2xlYW51cCBjYW4gYmUgYWRkZWQgaGVyZSBpZiBuZWVkZWRcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==