542ef4287d5cfe7417bec26027e692cb
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const micCapture_1 = require("../micCapture");
// Mock AudioContext and related APIs for testing
class MockAudioContext {
    constructor() {
        this.sampleRate = 48000;
        this.state = 'running';
        this.audioWorklet = {
            addModule: jest.fn().mockResolvedValue(undefined)
        };
        this.createMediaStreamSource = jest.fn().mockReturnValue({
            connect: jest.fn(),
            disconnect: jest.fn()
        });
        this.resume = jest.fn().mockResolvedValue(undefined);
        this.close = jest.fn().mockResolvedValue(undefined);
    }
}
class MockAudioWorkletNode {
    constructor(context, processorName) {
        this.port = {
            postMessage: jest.fn(),
            onmessage: null
        };
        this.connect = jest.fn();
        this.disconnect = jest.fn();
    }
}
class MockMediaStream {
    constructor() {
        this.getTracks = jest.fn().mockReturnValue([
            { stop: jest.fn() }
        ]);
    }
}
// Mock navigator.mediaDevices
const mockGetUserMedia = jest.fn();
Object.defineProperty(navigator, 'mediaDevices', {
    value: {
        getUserMedia: mockGetUserMedia
    },
    configurable: true
});
// Mock global constructors
global.AudioContext = MockAudioContext;
global.AudioWorkletNode = MockAudioWorkletNode;
global.URL = class {
    constructor(url, base) {
        this.href = url;
    }
};
describe('MicCapture', () => {
    let micCapture;
    beforeEach(() => {
        micCapture = new micCapture_1.MicCapture();
        mockGetUserMedia.mockResolvedValue(new MockMediaStream());
    });
    afterEach(async () => {
        if (micCapture.capturing) {
            await micCapture.dispose();
        }
        jest.clearAllMocks();
    });
    describe('Initialization', () => {
        test('should initialize successfully', async () => {
            await expect(micCapture.initialize()).resolves.not.toThrow();
            expect(mockGetUserMedia).toHaveBeenCalledWith({
                audio: {
                    sampleRate: 48000,
                    channelCount: 1,
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });
        });
        test('should throw error if initialization fails', async () => {
            mockGetUserMedia.mockRejectedValue(new Error('Permission denied'));
            await expect(micCapture.initialize()).rejects.toThrow('Failed to initialize microphone capture');
        });
    });
    describe('Capture Control', () => {
        beforeEach(async () => {
            await micCapture.initialize();
        });
        test('should start capture successfully', async () => {
            await expect(micCapture.startCapture()).resolves.not.toThrow();
            expect(micCapture.capturing).toBe(true);
        });
        test('should stop capture successfully', async () => {
            await micCapture.startCapture();
            micCapture.stopCapture();
            expect(micCapture.capturing).toBe(false);
        });
        test('should throw error when starting capture without initialization', async () => {
            const uninitializedCapture = new micCapture_1.MicCapture();
            await expect(uninitializedCapture.startCapture()).rejects.toThrow('MicCapture not initialized');
        });
    });
    describe('Properties', () => {
        test('should return correct sample rate', () => {
            expect(micCapture.sampleRate).toBe(16000);
        });
        test('should return correct frame size (100ms at 16kHz)', () => {
            expect(micCapture.frameSize).toBe(1600);
        });
    });
    describe('Offline Sine Wave Test', () => {
        test('should process sine wave without byte-order flip', async () => {
            // Create a mock shared buffer for testing
            const frameSize = 1600; // 100ms at 16kHz
            const bufferFrames = 10;
            const headerSize = 2;
            const bufferSize = headerSize + (frameSize * bufferFrames);
            const sharedBuffer = new SharedArrayBuffer(bufferSize * Int16Array.BYTES_PER_ELEMENT);
            const sharedBufferView = new Int16Array(sharedBuffer);
            // Initialize buffer indices
            Atomics.store(sharedBufferView, 0, 0); // writeIndex
            Atomics.store(sharedBufferView, 1, 0); // readIndex
            // Generate a sine wave at 440Hz (A4) for testing
            const sampleRate = 16000;
            const frequency = 440;
            const amplitude = 16000; // Use a significant amplitude for testing
            const testSamples = frameSize;
            // Generate sine wave samples
            const sineWave = new Int16Array(testSamples);
            for (let i = 0; i < testSamples; i++) {
                const t = i / sampleRate;
                const sample = Math.round(amplitude * Math.sin(2 * Math.PI * frequency * t));
                sineWave[i] = Math.max(-32768, Math.min(32767, sample));
            }
            // Simulate writing sine wave to shared buffer
            for (let i = 0; i < testSamples; i++) {
                const bufferIndex = headerSize + i;
                sharedBufferView[bufferIndex] = sineWave[i];
            }
            // Update write index to indicate data is available
            Atomics.store(sharedBufferView, 0, testSamples);
            // Mock the shared buffer in micCapture
            micCapture.sharedBufferView = sharedBufferView;
            micCapture.isCapturing = true;
            // Read one frame using the private readFrame method
            const frame = micCapture.readFrame();
            expect(frame).not.toBeNull();
            expect(frame.length).toBe(frameSize);
            // Verify that the data matches our sine wave (no byte-order flip)
            for (let i = 0; i < Math.min(testSamples, frame.length); i++) {
                expect(frame[i]).toBe(sineWave[i]);
            }
            // Test byte conversion to Uint8Array
            micCapture.stopCapture();
            micCapture.isCapturing = true;
            // Get one frame from the async iterator
            const iterator = micCapture.read();
            const result = await iterator.next();
            expect(result.done).toBe(false);
            expect(result.value).toBeInstanceOf(Uint8Array);
            expect(result.value.length).toBe(frameSize * 2); // 2 bytes per sample
            // Verify byte order (little-endian)
            const uint8Frame = result.value;
            for (let i = 0; i < Math.min(10, frameSize); i++) { // Test first 10 samples
                const originalSample = sineWave[i];
                const lowByte = uint8Frame[i * 2];
                const highByte = uint8Frame[i * 2 + 1];
                const reconstructedSample = lowByte | (highByte << 8);
                // Handle signed 16-bit conversion
                const signedSample = reconstructedSample > 32767 ? reconstructedSample - 65536 : reconstructedSample;
                expect(signedSample).toBe(originalSample);
            }
        });
        test('should handle empty buffer gracefully', async () => {
            // Mock empty shared buffer
            const frameSize = 1600;
            const bufferFrames = 10;
            const headerSize = 2;
            const bufferSize = headerSize + (frameSize * bufferFrames);
            const sharedBuffer = new SharedArrayBuffer(bufferSize * Int16Array.BYTES_PER_ELEMENT);
            const sharedBufferView = new Int16Array(sharedBuffer);
            // Initialize buffer indices (both at 0, indicating empty buffer)
            Atomics.store(sharedBufferView, 0, 0); // writeIndex
            Atomics.store(sharedBufferView, 1, 0); // readIndex
            micCapture.sharedBufferView = sharedBufferView;
            // Read frame from empty buffer
            const frame = micCapture.readFrame();
            expect(frame).toBeNull();
        });
    });
    describe('Resource Cleanup', () => {
        test('should dispose resources properly', async () => {
            await micCapture.initialize();
            await micCapture.startCapture();
            await expect(micCapture.dispose()).resolves.not.toThrow();
            expect(micCapture.capturing).toBe(false);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2Rpa3NoYW50dmFzaGlzdGhhL1ByZXBCZXR0ci9saWIvYXVkaW8vX190ZXN0c19fL21pY0NhcHR1cmUudGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLDhDQUEyQztBQUUzQyxpREFBaUQ7QUFDakQsTUFBTSxnQkFBZ0I7SUFBdEI7UUFDRSxlQUFVLEdBQUcsS0FBSyxDQUFDO1FBQ25CLFVBQUssR0FBRyxTQUFTLENBQUM7UUFFbEIsaUJBQVksR0FBRztZQUNiLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDO1NBQ2xELENBQUM7UUFFRiw0QkFBdUIsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO1lBQ2xELE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ2xCLFVBQVUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1NBQ3RCLENBQUMsQ0FBQztRQUVILFdBQU0sR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDaEQsVUFBSyxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNqRCxDQUFDO0NBQUE7QUFFRCxNQUFNLG9CQUFvQjtJQVN4QixZQUFZLE9BQU8sRUFBRSxhQUFhO1FBUmxDLFNBQUksR0FBRztZQUNMLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ3RCLFNBQVMsRUFBRSxJQUFJO1NBQ2hCLENBQUM7UUFFRixZQUFPLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3BCLGVBQVUsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7SUFFYyxDQUFDO0NBQ3ZDO0FBRUQsTUFBTSxlQUFlO0lBQXJCO1FBQ0UsY0FBUyxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUM7WUFDcEMsRUFBRSxJQUFJLEVBQUUsSUFBSSxD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QyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDMUQsTUFBTSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDM0MsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9kaWtzaGFudHZhc2hpc3RoYS9QcmVwQmV0dHIvbGliL2F1ZGlvL19fdGVzdHNfXy9taWNDYXB0dXJlLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTWljQ2FwdHVyZSB9IGZyb20gJy4uL21pY0NhcHR1cmUnO1xuXG4vLyBNb2NrIEF1ZGlvQ29udGV4dCBhbmQgcmVsYXRlZCBBUElzIGZvciB0ZXN0aW5nXG5jbGFzcyBNb2NrQXVkaW9Db250ZXh0IHtcbiAgc2FtcGxlUmF0ZSA9IDQ4MDAwO1xuICBzdGF0ZSA9ICdydW5uaW5nJztcbiAgXG4gIGF1ZGlvV29ya2xldCA9IHtcbiAgICBhZGRNb2R1bGU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpXG4gIH07XG4gIFxuICBjcmVhdGVNZWRpYVN0cmVhbVNvdXJjZSA9IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgIGNvbm5lY3Q6IGplc3QuZm4oKSxcbiAgICBkaXNjb25uZWN0OiBqZXN0LmZuKClcbiAgfSk7XG4gIFxuICByZXN1bWUgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcbiAgY2xvc2UgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcbn1cblxuY2xhc3MgTW9ja0F1ZGlvV29ya2xldE5vZGUge1xuICBwb3J0ID0ge1xuICAgIHBvc3RNZXNzYWdlOiBqZXN0LmZuKCksXG4gICAgb25tZXNzYWdlOiBudWxsXG4gIH07XG4gIFxuICBjb25uZWN0ID0gamVzdC5mbigpO1xuICBkaXNjb25uZWN0ID0gamVzdC5mbigpO1xuICBcbiAgY29uc3RydWN0b3IoY29udGV4dCwgcHJvY2Vzc29yTmFtZSkge31cbn1cblxuY2xhc3MgTW9ja01lZGlhU3RyZWFtIHtcbiAgZ2V0VHJhY2tzID0gamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZShbXG4gICAgeyBzdG9wOiBqZXN0LmZuKCkgfVxuICBdKTtcbn1cblxuLy8gTW9jayBuYXZpZ2F0b3IubWVkaWFEZXZpY2VzXG5jb25zdCBtb2NrR2V0VXNlck1lZGlhID0gamVzdC5mbigpO1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KG5hdmlnYXRvciwgJ21lZGlhRGV2aWNlcycsIHtcbiAgdmFsdWU6IHtcbiAgICBnZXRVc2VyTWVkaWE6IG1vY2tHZXRVc2VyTWVkaWFcbiAgfSxcbiAgY29uZmlndXJhYmxlOiB0cnVlXG59KTtcblxuLy8gTW9jayBnbG9iYWwgY29uc3RydWN0b3JzXG4oZ2xvYmFsIGFzIGFueSkuQXVkaW9Db250ZXh0ID0gTW9ja0F1ZGlvQ29udGV4dDtcbihnbG9iYWwgYXMgYW55KS5BdWRpb1dvcmtsZXROb2RlID0gTW9ja0F1ZGlvV29ya2xldE5vZGU7XG4oZ2xvYmFsIGFzIGFueSkuVVJMID0gY2xhc3Mge1xuICBocmVmOiBzdHJpbmc7XG4gIGNvbnN0cnVjdG9yKHVybDogc3RyaW5nLCBiYXNlPzogc3RyaW5nKSB7XG4gICAgdGhpcy5ocmVmID0gdXJsO1xuICB9XG59O1xuXG5kZXNjcmliZSgnTWljQ2FwdHVyZScsICgpID0+IHtcbiAgbGV0IG1pY0NhcHR1cmU6IE1pY0NhcHR1cmU7XG4gIFxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBtaWNDYXB0dXJlID0gbmV3IE1pY0NhcHR1cmUoKTtcbiAgICBtb2NrR2V0VXNlck1lZGlhLm1vY2tSZXNvbHZlZFZhbHVlKG5ldyBNb2NrTWVkaWFTdHJlYW0oKSk7XG4gIH0pO1xuICBcbiAgYWZ0ZXJFYWNoKGFzeW5jICgpID0+IHtcbiAgICBpZiAobWljQ2FwdHVyZS5jYXB0dXJpbmcpIHtcbiAgICAgIGF3YWl0IG1pY0NhcHR1cmUuZGlzcG9zZSgpO1xuICAgIH1cbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgfSk7XG4gIFxuICBkZXNjcmliZSgnSW5pdGlhbGl6YXRpb24nLCAoKSA9PiB7XG4gICAgdGVzdCgnc2hvdWxkIGluaXRpYWxpemUgc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgZXhwZWN0KG1pY0NhcHR1cmUuaW5pdGlhbGl6ZSgpKS5yZXNvbHZlcy5ub3QudG9UaHJvdygpO1xuICAgICAgZXhwZWN0KG1vY2tHZXRVc2VyTWVkaWEpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgICAgYXVkaW86IHtcbiAgICAgICAgICBzYW1wbGVSYXRlOiA0ODAwMCxcbiAgICAgICAgICBjaGFubmVsQ291bnQ6IDEsXG4gICAgICAgICAgZWNob0NhbmNlbGxhdGlvbjogdHJ1ZSxcbiAgICAgICAgICBub2lzZVN1cHByZXNzaW9uOiB0cnVlLFxuICAgICAgICAgIGF1dG9HYWluQ29udHJvbDogdHJ1ZVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgICBcbiAgICB0ZXN0KCdzaG91bGQgdGhyb3cgZXJyb3IgaWYgaW5pdGlhbGl6YXRpb24gZmFpbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2NrR2V0VXNlck1lZGlhLm1vY2tSZWplY3RlZFZhbHVlKG5ldyBFcnJvcignUGVybWlzc2lvbiBkZW5pZWQnKSk7XG4gICAgICBhd2FpdCBleHBlY3QobWljQ2FwdHVyZS5pbml0aWFsaXplKCkpLnJlamVjdHMudG9UaHJvdygnRmFpbGVkIHRvIGluaXRpYWxpemUgbWljcm9waG9uZSBjYXB0dXJlJyk7XG4gICAgfSk7XG4gIH0pO1xuICBcbiAgZGVzY3JpYmUoJ0NhcHR1cmUgQ29udHJvbCcsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IG1pY0NhcHR1cmUuaW5pdGlhbGl6ZSgpO1xuICAgIH0pO1xuICAgIFxuICAgIHRlc3QoJ3Nob3VsZCBzdGFydCBjYXB0dXJlIHN1Y2Nlc3NmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IGV4cGVjdChtaWNDYXB0dXJlLnN0YXJ0Q2FwdHVyZSgpKS5yZXNvbHZlcy5ub3QudG9UaHJvdygpO1xuICAgICAgZXhwZWN0KG1pY0NhcHR1cmUuY2FwdHVyaW5nKS50b0JlKHRydWUpO1xuICAgIH0pO1xuICAgIFxuICAgIHRlc3QoJ3Nob3VsZCBzdG9wIGNhcHR1cmUgc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgbWljQ2FwdHVyZS5zdGFydENhcHR1cmUoKTtcbiAgICAgIG1pY0NhcHR1cmUuc3RvcENhcHR1cmUoKTtcbiAgICAgIGV4cGVjdChtaWNDYXB0dXJlLmNhcHR1cmluZykudG9CZShmYWxzZSk7XG4gICAgfSk7XG4gICAgXG4gICAgdGVzdCgnc2hvdWxkIHRocm93IGVycm9yIHdoZW4gc3RhcnRpbmcgY2FwdHVyZSB3aXRob3V0IGluaXRpYWxpemF0aW9uJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdW5pbml0aWFsaXplZENhcHR1cmUgPSBuZXcgTWljQ2FwdHVyZSgpO1xuICAgICAgYXdhaXQgZXhwZWN0KHVuaW5pdGlhbGl6ZWRDYXB0dXJlLnN0YXJ0Q2FwdHVyZSgpKS5yZWplY3RzLnRvVGhyb3coJ01pY0NhcHR1cmUgbm90IGluaXRpYWxpemVkJyk7XG4gICAgfSk7XG4gIH0pO1xuICBcbiAgZGVzY3JpYmUoJ1Byb3BlcnRpZXMnLCAoKSA9PiB7XG4gICAgdGVzdCgnc2hvdWxkIHJldHVybiBjb3JyZWN0IHNhbXBsZSByYXRlJywgKCkgPT4ge1xuICAgICAgZXhwZWN0KG1pY0NhcHR1cmUuc2FtcGxlUmF0ZSkudG9CZSgxNjAwMCk7XG4gICAgfSk7XG4gICAgXG4gICAgdGVzdCgnc2hvdWxkIHJldHVybiBjb3JyZWN0IGZyYW1lIHNpemUgKDEwMG1zIGF0IDE2a0h6KScsICgpID0+IHtcbiAgICAgIGV4cGVjdChtaWNDYXB0dXJlLmZyYW1lU2l6ZSkudG9CZSgxNjAwKTtcbiAgICB9KTtcbiAgfSk7XG4gIFxuICBkZXNjcmliZSgnT2ZmbGluZSBTaW5lIFdhdmUgVGVzdCcsICgpID0+IHtcbiAgICB0ZXN0KCdzaG91bGQgcHJvY2VzcyBzaW5lIHdhdmUgd2l0aG91dCBieXRlLW9yZGVyIGZsaXAnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBDcmVhdGUgYSBtb2NrIHNoYXJlZCBidWZmZXIgZm9yIHRlc3RpbmdcbiAgICAgIGNvbnN0IGZyYW1lU2l6ZSA9IDE2MDA7IC8vIDEwMG1zIGF0IDE2a0h6XG4gICAgICBjb25zdCBidWZmZXJGcmFtZXMgPSAxMDtcbiAgICAgIGNvbnN0IGhlYWRlclNpemUgPSAyO1xuICAgICAgY29uc3QgYnVmZmVyU2l6ZSA9IGhlYWRlclNpemUgKyAoZnJhbWVTaXplICogYnVmZmVyRnJhbWVzKTtcbiAgICAgIGNvbnN0IHNoYXJlZEJ1ZmZlciA9IG5ldyBTaGFyZWRBcnJheUJ1ZmZlcihidWZmZXJTaXplICogSW50MTZBcnJheS5CWVRFU19QRVJfRUxFTUVOVCk7XG4gICAgICBjb25zdCBzaGFyZWRCdWZmZXJWaWV3ID0gbmV3IEludDE2QXJyYXkoc2hhcmVkQnVmZmVyKTtcbiAgICAgIFxuICAgICAgLy8gSW5pdGlhbGl6ZSBidWZmZXIgaW5kaWNlc1xuICAgICAgQXRvbWljcy5zdG9yZShzaGFyZWRCdWZmZXJWaWV3LCAwLCAwKTsgLy8gd3JpdGVJbmRleFxuICAgICAgQXRvbWljcy5zdG9yZShzaGFyZWRCdWZmZXJWaWV3LCAxLCAwKTsgLy8gcmVhZEluZGV4XG4gICAgICBcbiAgICAgIC8vIEdlbmVyYXRlIGEgc2luZSB3YXZlIGF0IDQ0MEh6IChBNCkgZm9yIHRlc3RpbmdcbiAgICAgIGNvbnN0IHNhbXBsZVJhdGUgPSAxNjAwMDtcbiAgICAgIGNvbnN0IGZyZXF1ZW5jeSA9IDQ0MDtcbiAgICAgIGNvbnN0IGFtcGxpdHVkZSA9IDE2MDAwOyAvLyBVc2UgYSBzaWduaWZpY2FudCBhbXBsaXR1ZGUgZm9yIHRlc3RpbmdcbiAgICAgIGNvbnN0IHRlc3RTYW1wbGVzID0gZnJhbWVTaXplO1xuICAgICAgXG4gICAgICAvLyBHZW5lcmF0ZSBzaW5lIHdhdmUgc2FtcGxlc1xuICAgICAgY29uc3Qgc2luZVdhdmUgPSBuZXcgSW50MTZBcnJheSh0ZXN0U2FtcGxlcyk7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRlc3RTYW1wbGVzOyBpKyspIHtcbiAgICAgICAgY29uc3QgdCA9IGkgLyBzYW1wbGVSYXRlO1xuICAgICAgICBjb25zdCBzYW1wbGUgPSBNYXRoLnJvdW5kKGFtcGxpdHVkZSAqIE1hdGguc2luKDIgKiBNYXRoLlBJICogZnJlcXVlbmN5ICogdCkpO1xuICAgICAgICBzaW5lV2F2ZVtpXSA9IE1hdGgubWF4KC0zMjc2OCwgTWF0aC5taW4oMzI3NjcsIHNhbXBsZSkpO1xuICAgICAgfVxuICAgICAgXG4gICAgICAvLyBTaW11bGF0ZSB3cml0aW5nIHNpbmUgd2F2ZSB0byBzaGFyZWQgYnVmZmVyXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRlc3RTYW1wbGVzOyBpKyspIHtcbiAgICAgICAgY29uc3QgYnVmZmVySW5kZXggPSBoZWFkZXJTaXplICsgaTtcbiAgICAgICAgc2hhcmVkQnVmZmVyVmlld1tidWZmZXJJbmRleF0gPSBzaW5lV2F2ZVtpXTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gVXBkYXRlIHdyaXRlIGluZGV4IHRvIGluZGljYXRlIGRhdGEgaXMgYXZhaWxhYmxlXG4gICAgICBBdG9taWNzLnN0b3JlKHNoYXJlZEJ1ZmZlclZpZXcsIDAsIHRlc3RTYW1wbGVzKTtcbiAgICAgIFxuICAgICAgLy8gTW9jayB0aGUgc2hhcmVkIGJ1ZmZlciBpbiBtaWNDYXB0dXJlXG4gICAgICAobWljQ2FwdHVyZSBhcyBhbnkpLnNoYXJlZEJ1ZmZlclZpZXcgPSBzaGFyZWRCdWZmZXJWaWV3O1xuICAgICAgKG1pY0NhcHR1cmUgYXMgYW55KS5pc0NhcHR1cmluZyA9IHRydWU7XG4gICAgICBcbiAgICAgIC8vIFJlYWQgb25lIGZyYW1lIHVzaW5nIHRoZSBwcml2YXRlIHJlYWRGcmFtZSBtZXRob2RcbiAgICAgIGNvbnN0IGZyYW1lID0gKG1pY0NhcHR1cmUgYXMgYW55KS5yZWFkRnJhbWUoKTtcbiAgICAgIFxuICAgICAgZXhwZWN0KGZyYW1lKS5ub3QudG9CZU51bGwoKTtcbiAgICAgIGV4cGVjdChmcmFtZS5sZW5ndGgpLnRvQmUoZnJhbWVTaXplKTtcbiAgICAgIFxuICAgICAgLy8gVmVyaWZ5IHRoYXQgdGhlIGRhdGEgbWF0Y2hlcyBvdXIgc2luZSB3YXZlIChubyBieXRlLW9yZGVyIGZsaXApXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IE1hdGgubWluKHRlc3RTYW1wbGVzLCBmcmFtZS5sZW5ndGgpOyBpKyspIHtcbiAgICAgICAgZXhwZWN0KGZyYW1lW2ldKS50b0JlKHNpbmVXYXZlW2ldKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gVGVzdCBieXRlIGNvbnZlcnNpb24gdG8gVWludDhBcnJheVxuICAgICAgbWljQ2FwdHVyZS5zdG9wQ2FwdHVyZSgpO1xuICAgICAgKG1pY0NhcHR1cmUgYXMgYW55KS5pc0NhcHR1cmluZyA9IHRydWU7XG4gICAgICBcbiAgICAgIC8vIEdldCBvbmUgZnJhbWUgZnJvbSB0aGUgYXN5bmMgaXRlcmF0b3JcbiAgICAgIGNvbnN0IGl0ZXJhdG9yID0gbWljQ2FwdHVyZS5yZWFkKCk7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBpdGVyYXRvci5uZXh0KCk7XG4gICAgICBcbiAgICAgIGV4cGVjdChyZXN1bHQuZG9uZSkudG9CZShmYWxzZSk7XG4gICAgICBleHBlY3QocmVzdWx0LnZhbHVlKS50b0JlSW5zdGFuY2VPZihVaW50OEFycmF5KTtcbiAgICAgIGV4cGVjdChyZXN1bHQudmFsdWUhLmxlbmd0aCkudG9CZShmcmFtZVNpemUgKiAyKTsgLy8gMiBieXRlcyBwZXIgc2FtcGxlXG4gICAgICBcbiAgICAgIC8vIFZlcmlmeSBieXRlIG9yZGVyIChsaXR0bGUtZW5kaWFuKVxuICAgICAgY29uc3QgdWludDhGcmFtZSA9IHJlc3VsdC52YWx1ZSE7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IE1hdGgubWluKDEwLCBmcmFtZVNpemUpOyBpKyspIHsgLy8gVGVzdCBmaXJzdCAxMCBzYW1wbGVzXG4gICAgICAgIGNvbnN0IG9yaWdpbmFsU2FtcGxlID0gc2luZVdhdmVbaV07XG4gICAgICAgIGNvbnN0IGxvd0J5dGUgPSB1aW50OEZyYW1lW2kgKiAyXTtcbiAgICAgICAgY29uc3QgaGlnaEJ5dGUgPSB1aW50OEZyYW1lW2kgKiAyICsgMV07XG4gICAgICAgIGNvbnN0IHJlY29uc3RydWN0ZWRTYW1wbGUgPSBsb3dCeXRlIHwgKGhpZ2hCeXRlIDw8IDgpO1xuICAgICAgICBcbiAgICAgICAgLy8gSGFuZGxlIHNpZ25lZCAxNi1iaXQgY29udmVyc2lvblxuICAgICAgICBjb25zdCBzaWduZWRTYW1wbGUgPSByZWNvbnN0cnVjdGVkU2FtcGxlID4gMzI3NjcgPyByZWNvbnN0cnVjdGVkU2FtcGxlIC0gNjU1MzYgOiByZWNvbnN0cnVjdGVkU2FtcGxlO1xuICAgICAgICBleHBlY3Qoc2lnbmVkU2FtcGxlKS50b0JlKG9yaWdpbmFsU2FtcGxlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBcbiAgICB0ZXN0KCdzaG91bGQgaGFuZGxlIGVtcHR5IGJ1ZmZlciBncmFjZWZ1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gTW9jayBlbXB0eSBzaGFyZWQgYnVmZmVyXG4gICAgICBjb25zdCBmcmFtZVNpemUgPSAxNjAwO1xuICAgICAgY29uc3QgYnVmZmVyRnJhbWVzID0gMTA7XG4gICAgICBjb25zdCBoZWFkZXJTaXplID0gMjtcbiAgICAgIGNvbnN0IGJ1ZmZlclNpemUgPSBoZWFkZXJTaXplICsgKGZyYW1lU2l6ZSAqIGJ1ZmZlckZyYW1lcyk7XG4gICAgICBjb25zdCBzaGFyZWRCdWZmZXIgPSBuZXcgU2hhcmVkQXJyYXlCdWZmZXIoYnVmZmVyU2l6ZSAqIEludDE2QXJyYXkuQllURVNfUEVSX0VMRU1FTlQpO1xuICAgICAgY29uc3Qgc2hhcmVkQnVmZmVyVmlldyA9IG5ldyBJbnQxNkFycmF5KHNoYXJlZEJ1ZmZlcik7XG4gICAgICBcbiAgICAgIC8vIEluaXRpYWxpemUgYnVmZmVyIGluZGljZXMgKGJvdGggYXQgMCwgaW5kaWNhdGluZyBlbXB0eSBidWZmZXIpXG4gICAgICBBdG9taWNzLnN0b3JlKHNoYXJlZEJ1ZmZlclZpZXcsIDAsIDApOyAvLyB3cml0ZUluZGV4XG4gICAgICBBdG9taWNzLnN0b3JlKHNoYXJlZEJ1ZmZlclZpZXcsIDEsIDApOyAvLyByZWFkSW5kZXhcbiAgICAgIFxuICAgICAgKG1pY0NhcHR1cmUgYXMgYW55KS5zaGFyZWRCdWZmZXJWaWV3ID0gc2hhcmVkQnVmZmVyVmlldztcbiAgICAgIFxuICAgICAgLy8gUmVhZCBmcmFtZSBmcm9tIGVtcHR5IGJ1ZmZlclxuICAgICAgY29uc3QgZnJhbWUgPSAobWljQ2FwdHVyZSBhcyBhbnkpLnJlYWRGcmFtZSgpO1xuICAgICAgZXhwZWN0KGZyYW1lKS50b0JlTnVsbCgpO1xuICAgIH0pO1xuICB9KTtcbiAgXG4gIGRlc2NyaWJlKCdSZXNvdXJjZSBDbGVhbnVwJywgKCkgPT4ge1xuICAgIHRlc3QoJ3Nob3VsZCBkaXNwb3NlIHJlc291cmNlcyBwcm9wZXJseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IG1pY0NhcHR1cmUuaW5pdGlhbGl6ZSgpO1xuICAgICAgYXdhaXQgbWljQ2FwdHVyZS5zdGFydENhcHR1cmUoKTtcbiAgICAgIFxuICAgICAgYXdhaXQgZXhwZWN0KG1pY0NhcHR1cmUuZGlzcG9zZSgpKS5yZXNvbHZlcy5ub3QudG9UaHJvdygpO1xuICAgICAgZXhwZWN0KG1pY0NhcHR1cmUuY2FwdHVyaW5nKS50b0JlKGZhbHNlKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==